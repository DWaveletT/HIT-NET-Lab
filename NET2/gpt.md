# 实验报告：GBN 协议与 SR 协议的设计与实现

## 1. 实验简介

本次实验主要通过编程实现并对比了两种常见的可靠数据传输协议：Go-Back-N (GBN) 协议和选择重传（Selective Repeat, SR）协议。我们实现了 GBN 和 SR 协议的服务端与客户端模型，并测试了它们的运行效果。实验过程中模拟了网络中的数据包丢失、延迟等情况，以验证不同协议在这些环境下的性能表现。

## 2. 协议原理

### 2.1 GBN 协议
GBN（Go-Back-N）协议是基于滑动窗口的可靠数据传输协议。其特点是：
- 发送方可以连续发送多个数据包，但接收方必须按顺序接收。若接收方收到的包不是期望的序号，便丢弃该包，并向发送方发送当前期待的包的 ACK（确认包）。
- 一旦发送方超时或收到错误的 ACK，需要重传从未确认的第一个包开始的所有数据包。

**优点**：实现简单。

**缺点**：当数据丢包时，必须重传所有未确认的数据包，导致传输效率下降。

### 2.2 SR 协议
SR（Selective Repeat）协议也是基于滑动窗口的可靠传输协议，但与 GBN 不同的是，SR 允许接收方接收并缓存失序的数据包，只有在接收到期望序号的数据包后才发送 ACK。发送方仅需要重传那些确实丢失或损坏的数据包。

**优点**：提高了传输效率，尤其在丢包率较高的网络中表现更佳。

**缺点**：相比 GBN，实现复杂度较高，需要更多缓存和序列号管理。

## 3. 完成内容及文件说明

### 3.1 文件结构
- `proto_gbn.py`：实现 GBN 协议。
- `proto_sr.py`：实现 SR 协议。
- `config.toml`：配置文件，用于配置窗口大小、超时等参数。
- `test.py`：用于测试 GBN 和 SR 协议的测试脚本，单向通信。
- `test_host1.py` 和 `test_host2.py`：用于测试 GBN 协议双向通信的脚本。
- `send_data.txt`：发送方的数据文件。
- `recv_data.txt`：接收方接收到的数据文件。

### 3.2 文件内容及功能说明

#### 3.2.1 `proto_gbn.py`
该文件实现了 GBN 协议的主要功能，包括数据包的发送、重传以及 ACK 的接收与处理。主要的类和方法：
- `GBN.__init__()`：初始化 GBN 协议，包括窗口大小、超时等参数。
- `GBN.make_packet()`：创建数据包。
- `GBN.send_packet()`：发送数据包，若窗口已满，则暂停发送。
- `GBN.send_again()`：在超时发生时重新发送未确认的数据包。
- `GBN.recv_ack()`：接收 ACK，滑动窗口。
- `GBN.recv_package()`：接收数据包并发送对应的 ACK。
- `GBN.run_server()`：启动服务端，进行数据发送。
- `GBN.run_client()`：启动客户端，进行数据接收。

#### 3.2.2 `proto_sr.py`
该文件实现了 SR 协议的主要功能。主要的类和方法类似于 `proto_gbn.py`，但 SR 协议允许接收方缓存失序的数据包：
- `SR.__init__()`：初始化 SR 协议。
- `SR.send_packet()`：发送数据包，并缓存数据。
- `SR.send_again()`：当超时发生时，仅重传那些丢失的数据包。
- `SR.recv_ack()`：接收 ACK，更新已确认的数据包。
- `SR.recv_package()`：接收数据包，缓存失序数据。
- `SR.run_server()` 和 `SR.run_client()`：分别用于服务端发送数据和客户端接收数据。

#### 3.2.3 `config.toml`
配置文件，用于定义以下参数：
- 窗口大小：GBN 和 SR 协议使用的窗口大小。
- 超时：发送端的超时设定。
- 丢包率：用于模拟丢包的概率。

#### 3.2.4 `test.py`
用于测试 GBN 或 SR 协议的脚本。根据用户输入，选择运行 GBN 或 SR 协议，分别启动服务端和客户端的线程，进行单向通信。

#### 3.2.5 `test_host1.py` 和 `test_host2.py`
这两个文件用于测试 GBN 协议的双向通信，分别模拟 A 和 B 两个主机的通信，双向发送和接收数据包。

#### 3.2.6 `send_data.txt` 和 `recv_data.txt`
- `send_data.txt`：发送方的数据文件，实验中通过该文件发送数据包。
- `recv_data.txt`：接收方接收到的数据，实验中检查此文件内容是否与发送方一致。

## 4. 测试方法

1. 运行 `test.py`，选择使用 GBN 或 SR 协议，分别启动服务端和客户端。
2. 发送数据文件 `send_data.txt`，查看接收方的 `recv_data.txt`，验证接收到的数据是否正确。
3. 测试不同丢包率下的协议表现，调整 `config.toml` 中的 `loss` 参数，观察传输延迟和重传情况。
4. 通过 `test_host1.py` 和 `test_host2.py` 测试 GBN 协议的双向通信，确保双向数据传输的正确性。

## 5. 测试结果

在测试过程中，我们分别验证了 GBN 和 SR 协议的传输效果：

- **GBN 协议**：
  - 在丢包率较低（<10%）时，GBN 协议能有效传输数据，但随着丢包率增加，重传数据包的次数显著增加，传输效率降低。
  - 文件内容 `recv_data.txt` 与发送的 `send_data.txt` 相符。

- **SR 协议**：
  - SR 协议在高丢包率（>10%）时依然能保持较好的传输效率，因其只重传丢失的数据包。
  - 传输完成后，接收文件 `recv_data.txt` 的内容与发送文件 `send_data.txt` 完全一致。

## 6. 总结

通过本次实验，我们成功实现了 GBN 和 SR 协议，并对其进行了性能测试。GBN 协议实现简单，但在丢包率较高的网络环境下性能下降较快。而 SR 协议能够通过选择性重传，提高传输效率，尤其适用于丢包率较高的网络环境。